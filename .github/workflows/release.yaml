name: Release
on:
  push:
    tags:
      - '*.*.*'        # 1.2.3

jobs:
  publish:
    strategy:
      # see: https://docs.github.com/ja/actions/using-github-hosted-runners/using-github-hosted-runners/about-github-hosted-runners
      fail-fast: false
      matrix:
        include:
          - os: windows-2025
            rid: win-x64
            archive_name: DotfilesLinker_win_amd64.zip
          - os: windows-11-arm
            rid: win-arm64
            archive_name: DotfilesLinker_win_arm64.zip
          - os: ubuntu-24.04
            rid: linux-x64
            archive_name: DotfilesLinker_linux_amd64.tar.gz
          - os: ubuntu-24.04-arm
            rid: linux-arm64
            archive_name: DotfilesLinker_linux_arm64.tar.gz
          - os: macos-13
            rid: osx-x64
            archive_name: DotfilesLinker_darwin_amd64.tar.gz
          - os: macos-15
            rid: osx-arm64
            archive_name: DotfilesLinker_darwin_arm64.tar.gz
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    timeout-minutes: 20
    steps:
      - name: Verify tag is pure semver x.y.z
        shell: bash
        env:
          TAG: ${{ github.ref_name }}
        run: |
          if [[ ! "${TAG}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag '${TAG}' is not a pure semantic version (x.y.z)."
            exit 1
          fi
          echo "Tag $TAG validated."
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: 9.0.x
      - name: dotnet publish (Native AOT)
        shell: bash
        env:
          TAG: ${{ github.ref_name }}
        run: dotnet publish -c Release -r ${{ matrix.rid }} -p:Version="${TAG}" --artifacts-path ./artifacts
      - name: Remove debug symbols
        shell: bash
        run: |
          # Remove PDB files (Windows)
          find ./artifacts -name "*.pdb" -type f -delete
          # Remove dSYM directories (macOS)
          find ./artifacts -name "*.dSYM" -type d -exec rm -rf {} +
          # Remove debug symbol files that might be present on Linux
          find ./artifacts -name "*.dbg" -type f -delete

          echo "Removed debug symbols files"
      - name: Create archive (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: Compress-Archive -Path ./artifacts/publish/DotfilesLinker/release_${{ matrix.rid }}/* -DestinationPath ${{ matrix.archive_name }}
      - name: Create archive (Linux/macOS)
        if: ${{ runner.os != 'Windows' }}
        shell: bash
        run: tar -czvf ${{ matrix.archive_name }} -C ./artifacts/publish/DotfilesLinker/release_${{ matrix.rid }} .
      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ matrix.archive_name }}
          path: ${{ matrix.archive_name }}
          retention-days: 1
          if-no-files-found: error

  release:
    needs: publish
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          path: ./artifacts
          merge-multiple: true
      - name: List artifacts
        shell: bash
        run: |
          echo "Downloaded artifacts:"
          find ./artifacts -type f | sort

          # Ensure we have artifacts to release
          if [ -z "$(find ./artifacts -type f)" ]; then
            echo "::error::No artifacts found. Aborting release creation."
            exit 1
          fi
      # Install Cosign for signing artifacts
      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1
        with:
          cosign-release: v2.5.0
      # Install Syft for SBOM generation
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@f325610c9f50a54015d37c8d16cb3b0e2c8f4de0 # v0.18.0
      # Setup Cosign keys for signing
      - name: Setup Cosign keys
        run: |
          echo "${{ secrets.SYNCED_COSIGN_PRIVATE_KEY }}" > cosign.key
          chmod 600 cosign.key
      - name: Generate checksums and signature
        shell: bash
        env:
          TAG: ${{ github.ref_name }}
          COSIGN_PASSWORD: ${{ secrets.SYNCED_COSIGN_PASSWORD }}
        run: |
          # Create checksums file
          CHECKSUM_FILE="./DotfilesLinker_${TAG}_checksums.txt"

          # Calculate SHA256 checksums for all artifacts
          cd ./artifacts
            sha256sum * > "${CHECKSUM_FILE}"
            cat "${CHECKSUM_FILE}"
          cd ..

          # Generate SBOM for each artifact
          echo "Generating SBOMs for artifacts..."
          for file in ./artifacts/*.{zip,tar.gz}; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              echo "Generating SBOM for $basename"
              syft "$file" -o spdx-json > "./artifacts/${basename}.sbom.json"
            fi
          done

          # Sign each artifact with Cosign
          echo "Signing artifacts with Cosign..."
          for file in ./artifacts/*.{zip,tar.gz}; do
            if [ -f "$file" ]; then
              echo "Signing $file"
              cosign sign-blob --key cosign.key --yes "$file" > "${file}.sig"

              # Also sign the SBOM
              sbom_file="${file}.sbom.json"
              if [ -f "$sbom_file" ]; then
                echo "Signing SBOM $sbom_file"
                cosign sign-blob --key cosign.key --yes "$sbom_file" > "${sbom_file}.sig"
              fi
            fi
          done

      # Clean up sensitive files
      - name: Clean up cosign key
        if: always()
        run: rm -f cosign.key

      - name: Create GitHub Release via gh
        shell: bash
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: gh release create "$TAG" --title "v$TAG" --generate-notes --fail-on-no-commits --draft ./artifacts/*
